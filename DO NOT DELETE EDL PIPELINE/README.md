# EDL Pipeline - Dhan ScanX Data Integration

This directory contains the tools and data for fetching stock market analytics from the **Dhan ScanX** API.

## ğŸš€ API Documentation

### 1. Fetch Full Market Data (`NSE Total Market`)
Used to retrieve detailed data for all available stocks in the NSE market.

*   **Endpoint**: `https://ow-scanx-analytics.dhan.co/customscan/fetchdt`
*   **Method**: `POST`
*   **Total Records**: ~2,775 unique symbols.

### 2. Fetch F&O Stock List (`FnoFlag: 1`)
Used to retrieve the precise universe of 207 F&O stocks.

*   **Endpoint**: `https://ow-scanx-analytics.dhan.co/customscan/fetchdt`
*   **Method**: `POST`
*   **Request Parameter**: `{"field": "FnoFlag", "op": "", "val": "1"}`
*   **Total Records**: **207** (Exact F&O universe).
*   **Pagination**: All 207 records are returned in a single call if `count` is set to 500.

### 3. Fetch F&O Lot Sizes
Extracted from the Dhan lot size page to provide the contract sizes for indices and stocks.

*   **Source**: `https://dhan.co/nse-fno-lot-size/`
*   **Total Records**: 212 instruments.
*   **Format**: Maps symbol and name to lot sizes for the current and future months.

## ğŸ›  Project Files

| File | Description |
| :--- | :--- |
| `fetch_dhan_data.py` | Python script to fetch the full NSE market (2,775 symbols). |
| `dhan_data_response.json` | Latest output for the full market fetch. |
| `master_isin_map.json` | Master lookup for Sym -> ISIN (Generated by `fetch_dhan_data.py`). |
| `fetch_fno_data.py` | Python script to fetch the exact 207 F&O stocks. |
| `fno_stocks_response.json` | Latest output for the 207 F&O stocks. |
| `fetch_fno_lot_sizes.py` | Python script to fetch and parse lot sizes. |
| `fno_lot_sizes_cleaned.json` | Data containing lot sizes for all F&O instruments. |
| `fetch_all_indices.py` | Python script to fetch all market indices (NSE/BSE). |
| `all_indices_list.json` | List of all market indices with their IDs and symbols. |
| `fetch_etf_data.py` | Python script to fetch all ETFs. |
| `etf_data_response.json` | Latest output for the all-ETF fetch. |
| `fetch_fno_expiry.py` | Python script to fetch the F&O expiry calendar. |
| `fno_expiry_calendar.json` | Cleaned data for upcoming F&O expiry dates. |
| `fetch_corporate_actions.py` | Python script to fetch both scenarios into separate files. |
| `history_corporate_actions.json` | 2 years of past events (Bonus, Dividend, etc.). |
| `upcoming_corporate_actions.json` | 2 months of future tracked events. |
| `fetch_surveillance_lists.py` | Python script to fetch NSE ASM/GSM lists. |
| `nse_asm_list.json` | Stocks under NSE Additional Surveillance Measure. |
| `nse_gsm_list.json` | Stocks under NSE Graded Surveillance Measure. |
| `fetch_circuit_stocks.py` | Python script to fetch Upper/Lower circuit stocks. |
| `upper_circuit_stocks.json` | Stocks hitting Upper Circuit limit. |
| `lower_circuit_stocks.json` | Stocks hitting Lower Circuit limit. |
| `fetch_incremental_price_bands.py` | Script for incremental daily price band changes. |
| `incremental_price_bands.json` | Latest daily price band updates (changes only). |
| `fetch_complete_price_bands.py` | Script for the complete list of price bands. |
| `complete_price_bands.json` | Complete list of all securities and their bands. |
| `fetch_fundamental_data.py` | Script to fetch fundamental data (Results, Ratios, Shareholding). |
| `fundamental_data.json` | Detailed financials for all 2,775+ stocks. |
| `single_stock_analyzer.py` | Tool to extract and display key metrics for a specific stock. |
| `fetch_all_ohlcv.py` | Script to fetch max historical Daily candles for all 2,775+ stocks (Parallel). |
| `ohlcv_data/` | Directory containing individual `SYMBOL.csv` files with lifetime OHLCV. |
| `advanced_metrics_processor.py` | Processor that calculates ADR, RVOL, ATH, and Turnover Moving Averages. |
| `fetch_company_filings.py` | Parallel fetcher for Exchange Filings (Announcements) for all symbols. |
| `company_filings/` | Directory containing individual `{SYMBOL}_filings.json` files. |
| `process_earnings_performance.py` | Extracts results dates and calculates post-earnings performance. |
| `bulk_market_analyzer.py` | Script to bulk analyze ALL stocks (Fundamentals + Technicals + Index Mapping). |
| `fetch_new_announcements.py` | High-speed fetcher for 2026 corporate updates and results via new Static API. |
| `all_company_announcements.json` | Consolidated list of latest news and results updates. |
| `fetch_bulk_block_deals.py` | Script to fetch Bulk/Block deals (last 30 days). |
| `bulk_block_deals.json` | Consolidated list of bulk and block deals. |
| `add_corporate_events.py` | Aggregates and maps ASM/GSM, Circuit Revisions, Deals, Insider Trading, and Results Out events. |
| `README.md` | This documentation file. |

## ğŸ“‚ Data Content & Field Reference

### 1. `all_stocks_fundamental_analysis.json`
This is the master output file containing the complete 3D analysis (Fundamental + Technical + Events).

*   **Fundamnetal Fields**: `Sales Actual`, `Profit Actual`, `Mcap`, `Industry`, `Sector`, `PEG`, `Forward PE`, `Listing Date`.
*   **Technical Fields**: `6 Month Returns(%)`, `ADR %`, `RVOL`, `% from 52W High`, `% from 52W Low`, `% from 52W High 200 Days EMA Volume`.
*   **Index Mapping**: Maps stocks to **38 specific indices** (Nifty 50, Next 50, Midcap, Smallcap, Sectorals like Auto, IT, Pharma, etc.).
*   **Event Markers**: Strategic icons for high-impact tracking.
*   **Latest Announcement**: The cleaned headline of the single most recent corporate filing.
*   **Latest Announcement URL**: Direct PDF link to the official exchange filing (BSE/NSE).

### 2. `dhan_data_response.json` & `fno_stocks_response.json`
*   **Content**: Technical and fundamental data for 2,775 stocks (Full) or 207 stocks (F&O).
*   **Key Fields**: 
    *   `Sym`, `DispSym`, `Isin`: Identifiers.
    *   `Ltp`, `volume`: Price and liquidity.
    *   `Mcap`, `Pe`, `Pb`, `Roe`, `ROCE`, `DivYeild`: Fundamental ratios.
    *   `DaySMA50CurrentCandle`, `DaySMA200CurrentCandle`: Trend indicators.
    *   `DayRSI14CurrentCandle`: Momentum indicator.
    *   `High1Yr`, `High3Yr`, `High5yr`: Historical benchmarks.

### 3. `fno_lot_sizes_cleaned.json`
*   **Content**: Derivative contract lot sizes for active instruments.
*   **Key Fields**:
    *   `Symbol`, `Name`: Instrument identity.
    *   `Lot_Feb2026`, `Lot_Mar2026`, etc.: Specific lot sizes for upcoming monthly expiries.

### 4. `all_indices_list.json`
*   **Content**: Master list of 194 indices across NSE and BSE.
*   **Key Fields**:
    *   `IndexName`, `Symbol`, `IndexID`: Unique mapping.
    *   `Exchange`, `BasedOnExch`: Connectivity details.
    *   `Ltp`, `Chng`, `PChng`: Live performance.

### 4. `etf_data_response.json`
*   **Content**: Detailed performance and cost data for 361 ETFs.
*   **Key Fields**:
    *   `ExpenseRatio`: The cost of holding the ETF.
    *   `Mcap`, `Volume`, `Ltp`: Asset size and liquidity.
    *   `RtAwayFrom5YearHigh`: Percentage drop from 5-year peak.

### 5. `fno_expiry_calendar.json`
*   **Content**: Schedule of all future expiry dates.
*   **Key Fields**:
    *   `InstrumentType`: `FUTIDX`, `FUTSTK`, `OPTIDX`, etc.
    *   `SymbolName`: Specific contract name.
    *   `ExpiryDate`: The settlement date (YYYY-MM-DD).

### 6. `corporate_actions_response.json`
*   **Content**: History and upcoming events for the **past 2 years** and **next 2 months** (Dynamic IST).
*   **Key Fields**:
    *   `CorpAct.ActType`: `DIVIDEND`, `SPLIT`, `BONUS`, `BUYBACK`, `RIGHTS`, etc.
    *   `CorpAct.ExDate`: The ex-date for the event.
    *   `Sym`, `PPerchange`: Stock symbol and recent movement.

## âš™ï¸ How to Update Data

**To refresh Full Market Data:**
```bash
python3 "fetch_dhan_data.py"
```

**To refresh F&O Data (207 Stocks):**
```bash
python3 "fetch_fno_data.py"
```

**To refresh F&O Lot Sizes:**
```bash
python3 "fetch_fno_lot_sizes.py"
```

**To refresh All Indices List:**
```bash
python3 "fetch_all_indices.py"
```

**To refresh ETF List:**
```bash
python3 "fetch_etf_data.py"
```

**To refresh F&O Expiry Calendar:**
```bash
python3 "fetch_fno_expiry.py"
```

**To refresh Corporate Actions (Last 2 Years):**
```bash
python3 "fetch_corporate_actions.py"
```

**To refresh Company Filings (Hybrid Mode - Recommended):**
```bash
python3 "fetch_company_filings.py"
```

**To refresh Advanced Indicators (Pivot, EMA, SMA):**
```bash
python3 "fetch_advanced_indicators.py"
```

**To refresh Surveillance Lists (ASM/GSM):**
```bash
python3 "fetch_surveillance_lists.py"
```

**To refresh Circuit Limit Stocks:**
```bash
python3 "fetch_circuit_stocks.py"
```

**To refresh Incremental Price Band Changes (Daily):**
```bash
python3 "fetch_incremental_price_bands.py"
```

**To refresh Complete Price Band List (All Securities):**
```bash
python3 "fetch_complete_price_bands.py"
```

**To refresh Fundamental Data (Results & Ratios):**
```bash
python3 "fetch_fundamental_data.py"
```

**To fetch NSE Listing Dates (Required for Listing Date field):**
```bash
curl -v -o nse_equity_list.csv "https://nsearchives.nseindia.com/content/equities/EQUITY_L.csv" --http1.1 --header "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
```

**To Analyze a Specific Stock:**
```bash
python3 single_stock_analyzer.py RELIANCE
```

**To Calculate Metrics for ALL Stocks (Fundamentals + Technicals):**
```bash
python3 bulk_market_analyzer.py
```

**To Inject Events & Announcements (CRITICAL FINAL STEP):**
```bash
python3 add_corporate_events.py
```

## **Important: Execution Pipeline**
To ensure data integrity, always run scripts in this order:
1.  **Data Fetching**: 
    - `fetch_dhan_data.py`
    - `fetch_company_filings.py` (Hybrid)
    - `fetch_market_news.py` (News Sentiment)
    - `fetch_advanced_indicators.py`
2.  **Base Analysis**: `bulk_market_analyzer.py`
3.  **Event Injection**: `add_corporate_events.py` (Must be last!)

## **Advanced Technical Analysis (Lifetime History)**

We have implemented a bulk downloader to fetch the maximum available daily OHLCV (Open, High, Low, Close, Volume) data for every stock in the pipeline.

### **How it Works:**
The script `fetch_all_ohlcv.py` iterates through all stocks, retrieves their unique Security ID (`Sid`), and makes a POST request to Dhan's historical data endpoint.

**API Endpoint:** `https://openweb-ticks.dhan.co/getDataH`

**Payload Used:**
```json
{
  "EXCH": "NSE",
  "SYM": "[SYMBOL]",
  "SEG": "E",
  "INST": "EQUITY",
  "SEC_ID": "[SECURITY_ID]",
  "EXPCODE": 0,
  "INTERVAL": "D",
  "START": 215634600,
  "END": [CURRENT_TIMESTAMP]
}
```
*   **START (215634600)**: This timestamp corresponds to **Oct 31, 1976**, which forces the API to return the earliest possible candle in its database (usually 2002 for most NSE stocks).
*   **INTERVAL**: Set to `"D"` to retrieve Daily candles.

### **Execution Sequence:**
1. **Download Raw Price History**:
   ```bash
   python3 fetch_all_ohlcv.py
   ```
2. **Calculate Advanced Technicals (ADR, RVOL, ATH)**:
   ```bash
   python3 advanced_metrics_processor.py
   ```
3. **Fetch Company Announcements (Filings)**:
   ```bash
   python3 fetch_company_filings.py
   ```
4. **Calculate Post-Earnings Performance**:
   ```bash
   python3 process_earnings_performance.py
   ```
*Data is merged into `all_stocks_fundamental_analysis.json`.*

### **Supported Advanced Metrics:**
*   **ATH (All-Time High)** & `% from ATH`: Lifetime price benchmarks.
*   **ADR % (5, 14, 20, 30 Days)**: Moving average of daily volatility.
*   **Rupee Turnover (20, 50, 100 Day Avg)**: Value flowing through the stock in Crores.
*   **RVOL (Relative Volume)**: Trend-strength indicator comparing current vs. 20D average volume.
*   **Quarterly Results Date**: Automatically extracted from latest "Financial Results" filing.
*   **Post-Earnings Returns**: `% change` and `Max % gain` since the results announcement.
    *   *Benchmark*: Uses the **Pre-Earnings Close** (the price strictly before the announcement) as the base to accurately measure the market reaction.
*   **EMA Volume (200 Day)**: Long-term volume trend.

**To refresh Event Markers (Insider Trading, Deals, Results, ASM):**
```bash
python3 "add_corporate_events.py"
```

**To refresh Bulk & Block Deals (Last 30 Days):**
```bash
python3 "fetch_bulk_block_deals.py"
```

---

### **Supported Advanced Metrics & Event Markers:**

#### **1. Advanced Metadata**
*   **Index Mapping**: Precise mapping into 38 sub-indices (e.g., Nifty 50, Microcap 250, Sectorals, etc.).
*   **Sector & Industry**: Standardized classification extracted from fundamental and technical feeds.

#### **2. Performance Benchmarks**
*   **ATH (All-Time High)** & `% from ATH`: Lifetime price benchmarks.
*   **6 Month Returns (%)**: Price performance over the last ~126 trading days.
*   **% from 52W Low**: Current price relative to the 52-week bottom.
*   **% from 52W High 200 Days EMA Volume**: Volume-trend analysis comparing current 200D EMA Volume to the peak volume year.
*   **ADR % (5, 14, 20, 30 Days)**: Moving average of daily volatility.
*   **Rupee Turnover (20, 50, 100 Day Avg)**: Value flowing through the stock in Crores.
*   **RVOL (Relative Volume)**: Trend-strength indicator comparing current vs. 20D average volume.


### **4. Technical Indicators (New)**
| **Field** | **Description** |
| :--- | :--- |
| **Technical Sentiment** | Quick summary of oscillators (e.g., "RSI: Neutral \| MACD: Bullish"). |
| **SMA Status** | Status of price vs Simple Moving Averages (20/50/200). Example: "SMA 200: Above (12.5%)". |
| **EMA Status** | Status of price vs Exponential Moving Averages (20/50/200). Example: "EMA 50: Below (-2.1%)". |
| **Pivot Point** | The Daily Classic Pivot Point level. |

### **5. Strategic Event Markers (`Event Markers` field)**
| Icon | Name | Logic |
| :--- | :--- | :--- |
| **â˜…: LTASM / STASM** | Surveillance | Stock is currently in NSE Long/Short Term ASM groups. |
| **ğŸ“Š: Results Out** | Recent Results | Financial results released in the **last 7 days**. |
| **ğŸ”‘: Insider Trading** | Mgmt Trades | SEBI Regulation 7(2) / Form C filings in last 15 days (filtered for trades). |
| **ğŸ“¦: Block Deal** | Deal Activity | Bulk or Block deal detected in last 7 trading days. |
| **#: +/- Revision** | Circuit Revision | Daily increment or decrement in price band limit (e.g. 5% -> 10%). |
| **â°: Results Coming** | Quarterly Results | Financial results announced/upcoming in the next 14 days. |
| **ğŸ: Bonus** | Bonus Issue | Upcoming Bonus allocation in next 30 days. |
| **âœ‚ï¸: Split** | Stock Split | Sub-division of equity shares in next 30 days. |
| **ğŸ’¸: Dividend** | Cash Dividend | Upcoming cash payout (Final/Interim/Special). |
| **ğŸ“ˆ: Rights** | Rights Issue | Upcoming rights entitlement for existing shareholders. |

**Latest Announcements**: Each stock also contains a `Recent Announcements` list with the top 5 updates (Headlines + PDFs).

### **6. Live News Feed (`News Feed` field)**
Contains the **Top 5** real-time news items for the stock, fetched from media sources.
Each item includes:
*   `Title`: The news headline.
*   `Sentiment`: AI-tagged sentiment (`positive`, `negative`, `neutral`).
*   `Date`: Unix timestamp of publication.

---
**Note**: This folder is part of the EDL Pipeline. **DO NOT DELETE**.
